<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="io.choerodon.agile.infra.mapper.StateMachineNodeMapper">

    <resultMap id="nodeDeployWithState" type="io.choerodon.agile.infra.dto.StateMachineNodeDTO">
        <id property="id" column="id"/>
        <result property="stateMachineId" column="state_machine_id"/>
        <result property="statusId" column="status_id"/>
        <result property="positionX" column="position_x"/>
        <result property="positionY" column="position_y"/>
        <result property="width" column="width"/>
        <result property="height" column="height"/>
        <result property="type" column="type"/>
        <result property="allStatusTransformId" column="all_status_transform_id"/>
        <result property="creationDate" column="creation_date"/>
        <result property="createdBy" column="created_by"/>
        <result property="lastUpdateDate" column="last_update_date"/>
        <result property="lastUpdatedBy" column="last_updated_by"/>
        <result property="objectVersionNumber" column="object_version_number"/>
        <association property="status" javaType="io.choerodon.agile.infra.dto.StatusDTO">
            <id property="id" column="s_id"/>
            <result property="name" column="s_name"/>
            <result property="description" column="s_description"/>
            <result property="type" column="s_type"/>
            <result property="organizationId" column="s_organization_id"/>
            <result property="creationDate" column="s_creation_date"/>
            <result property="createdBy" column="s_created_by"/>
            <result property="lastUpdateDate" column="s_last_update_date"/>
            <result property="lastUpdatedBy" column="s_last_updated_by"/>
            <result property="objectVersionNumber" column="s_object_version_number"/>
        </association>
    </resultMap>

    <select id="queryById" resultType="io.choerodon.agile.infra.dto.StateMachineNodeDTO">
        SELECT *
        FROM fd_state_machine_node
        WHERE organization_id = #{organizationId}
        and id = #{id}
    </select>

    <select id="getNodeDeployById" resultMap="nodeDeployWithState">
        SELECT
        SMN.*,
        STATE.id as s_id,
        STATE.name as s_name,
        STATE.description as s_description,
        STATE.type as s_type,
        STATE.organization_id as s_organization_id,
        STATE.creation_date as s_creation_date,
        STATE.created_by as s_created_by,
        STATE.last_update_date as s_last_update_date,
        STATE.last_updated_by as s_last_updated_by,
        STATE.object_version_number as s_object_version_number
        FROM fd_state_machine_node SMN
        LEFT JOIN fd_status STATE ON STATE.id = SMN.status_id
        WHERE SMN.id = #{nodeId}
    </select>

    <select id="getNodeDeployByStatusId" resultMap="nodeDeployWithState">
        SELECT
        SMN.*,
        STATE.id as s_id,
        STATE.name as s_name,
        STATE.description as s_description,
        STATE.type as s_type,
        STATE.organization_id as s_organization_id,
        STATE.creation_date as s_creation_date,
        STATE.created_by as s_created_by,
        STATE.last_update_date as s_last_update_date,
        STATE.last_updated_by as s_last_updated_by,
        STATE.object_version_number as s_object_version_number
        FROM fd_state_machine_node SMN
        LEFT JOIN fd_status STATE ON STATE.id = SMN.status_id
        WHERE STATE.id = #{statusId}
        AND SMN.state_machine_id = #{stateMachineId}
    </select>

    <select id="selectByStateMachineId" resultMap="nodeDeployWithState">
        SELECT
        SMN.*,
        STATE.id as s_id,
        STATE.name as s_name,
        STATE.description as s_description,
        STATE.type as s_type,
        STATE.organization_id as s_organization_id,
        STATE.creation_date as s_creation_date,
        STATE.created_by as s_created_by,
        STATE.last_update_date as s_last_update_date,
        STATE.last_updated_by as s_last_updated_by,
        STATE.object_version_number as s_object_version_number
        FROM fd_state_machine_node SMN
        LEFT JOIN fd_status STATE ON STATE.id = SMN.status_id
        WHERE SMN.state_machine_id = #{stateMachineId}
    </select>

    <select id="queryInitByStateMachineIds" resultType="io.choerodon.agile.infra.dto.StateMachineNodeDTO">
        SELECT
        *
        FROM fd_state_machine_node smn
        where smn.organization_id = #{organizationId} and smn.type = 'node_init' and smn.state_machine_id in
        <foreach collection="stateMachineIds" item="id" open="(" separator=","
                 close=")">
            #{id}
        </foreach>
    </select>

    <select id="checkStateDelete" resultType="java.lang.Long">
        SELECT
        count( SMN.id )
        FROM
        fd_state_machine_node SMN
        LEFT JOIN fd_state_machine SM ON SMN.state_machine_id = SM.id
        WHERE
        SMN.status_id = #{statusId}
        AND SM.organization_id = #{organizationId}
    </select>

    <select id="selectMaxPositionY" resultType="io.choerodon.agile.infra.dto.StateMachineNodeDTO">
        SELECT *
        FROM fd_state_machine_node
        WHERE position_y = (
            SELECT max(position_y)
            FROM fd_state_machine_node
            WHERE state_machine_id = #{stateMachineId}
        )
        LIMIT 1
    </select>

    <update id="updateAllStatusTransformId">
        UPDATE fd_state_machine_node
        SET all_status_transform_id = #{allStatusTransformId}
        WHERE organization_id = #{organizationId}
        AND id = #{id}
    </update>

    <select id="queryByStateMachineIds" resultType="io.choerodon.agile.infra.dto.StateMachineNodeDTO">
        SELECT
        *
        FROM fd_state_machine_node smn
        where smn.organization_id = #{organizationId}
        and smn.state_machine_id in
        <foreach collection="stateMachineIds" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </select>

    <insert id="batchInsert" useGeneratedKeys="true" keyProperty="id">
      insert into fd_state_machine_node(state_machine_id,status_id,type
      ,all_status_transform_id,organization_id,created_by,last_updated_by)
      values
        <foreach collection="list" item="item" separator=",">
            (#{item.stateMachineId},#{item.statusId},#{item.type}
            ,#{item.allStatusTransformId},#{item.organizationId},#{item.createdBy},#{item.lastUpdatedBy})
        </foreach>
    </insert>

    <select id="countIssueTypeByStatusIds" resultType="io.choerodon.agile.infra.dto.IssueCountDTO">
        select fsmn.status_id as id,fit.name as name from fd_state_machine_scheme_config fsmsc
        ,fd_state_machine_node fsmn,fd_issue_type fit
        where fsmsc.organization_id = #{organizationId}
        AND fsmsc.scheme_id = #{schemeId}
        AND fsmsc.state_machine_id = fsmn.state_machine_id
        AND fsmn.status_id in
        <foreach collection="statusIds" item="statusId" open="(" close=")" separator=",">
           #{statusId}
        </foreach>
        AND fit.id = fsmsc.issue_type_id
        AND fit.type_code not in ('issue_auto_test','issue_auto_test')
        AND fsmsc.issue_type_id != 0
        group by fsmn.status_id,fit.name
    </select>

    <select id="selectInitNode" resultType="io.choerodon.agile.infra.dto.StateMachineNodeDTO">
        select fsmn.* from fd_state_machine_scheme_config fsmsc
        ,fd_state_machine_node fsmn
         where fsmsc.organization_id = #{organizationId}
         AND fsmsc.scheme_id = #{schemeId}
         AND fsmsc.state_machine_id = fsmn.state_machine_id
         AND fsmn.status_id = #{statusId}
         AND fsmn.type = 'node_init'
    </select>
</mapper>
